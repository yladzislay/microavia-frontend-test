# Алгоритм покрытия полигона параллельными линиями (с использованием временного поворота)

Этот алгоритм предназначен для генерации набора параллельных линий (штриховки) внутри заданной многоугольной области (полигона). Линии ориентируются под определенным углом (`bearing`), располагаются на заданном расстоянии (`step`) друг от друга и могут иметь внешний отступ (`offset`) от краев полигона. Для упрощения генерации линий используется техника временного поворота системы координат.

---

## Этап 1: Подготовка и трансформация

### Шаг 1.1: Инициализация полигона
-   Формируем валидный GeoJSON полигон из входных координат, убеждаясь в его замкнутости.

### Шаг 1.2: Определение центра и нормализация угла
-   Вычисляем центроид полигона – он будет служить центром для операций вращения.
-   Нормализуем входной угол `bearing` (например, к диапазону 0-180 градусов).

### Шаг 1.3: Временный поворот полигона
-   Поворачиваем полигон вокруг его центроида на угол, обратный нормализованному `bearing`.
-   **Цель:** В этой новой, "повернутой" системе координат задача сводится к генерации простых горизонтальных линий.

---

## Этап 2: Генерация "родительских" горизонтальных линий в повернутой системе

### Шаг 2.1: Определение границ для генерации
-   На основе Bounding Box (ограничивающего прямоугольника) **повернутого** полигона определяем вертикальный диапазон (минимальную и максимальную "широту" в повернутой системе), в котором будут генерироваться линии.
-   Учитываем запас сверху и снизу, чтобы гарантированно покрыть весь полигон с учетом возможных последующих отступов.

### Шаг 2.2: Создание горизонтальных линий-заготовок
-   Начиная от нижней границы определенного диапазона, генерируем первую горизонтальную линию. Длина линии выбирается так, чтобы она заведомо пересекала всю "ширину" повернутого полигона с запасом.
-   Каждая последующая горизонтальная линия генерируется путем смещения предыдущей "вверх" (вдоль "вертикальной" оси повернутой системы) на расстояние, равное `step` (шаг штриховки).
-   Процесс продолжается до тех пор, пока не будет покрыта вся вертикальная протяженность повернутого полигона с учетом запасов.
-   Предусматривается механизм защиты от бесконечного цикла.

---

## Этап 3: Отсечение линий по контуру повернутого полигона

### Шаг 3.1: Пересечение линий и полигона
-   Для каждой сгенерированной "родительской" горизонтальной линии находим ее части, которые лежат внутри **повернутого** полигона. Используется функция `turf.intersect`.
-   Линии, не пересекающие полигон, отбрасываются. Если линия пересекает полигон несколько раз, сохраняются все внутренние сегменты.

---

## Этап 4: Применение внешнего отступа (offset)

### Шаг 4.1: Удлинение отсеченных сегментов
-   Если задан `offset > 0`, каждый полученный на предыдущем этапе сегмент линии удлиняется с обоих концов.
-   Начальная точка смещается "назад" (против направления сегмента) на `offset` метров.
-   Конечная точка смещается "вперед" (по направлению сегмента) на `offset` метров.

---

## Этап 5: Возвращение линий в исходную ориентацию

### Шаг 5.1: Обратный поворот линий
-   Все обработанные сегменты линий (с примененным `offset`) поворачиваются обратно на исходный угол `bearing`.
-   Центр вращения используется тот же – центроид исходного полигона.
-   **Результат:** Линии теперь корректно ориентированы в глобальной системе координат.

---

## Этап 6: Форматирование результата

### Шаг 6.1: Преобразование в выходной формат
-   Координаты полученных линий преобразуются из формата GeoJSON в требуемый выходной формат (массив массивов координат).

---